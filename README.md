# Claudex v2

Contextual memory and observation system for Claude Code, implemented as TypeScript hooks with a Python hologram sidecar.

## Prerequisites

- Node.js >= 20.0.0
- Python 3.10+ (for hologram sidecar)

## Setup

```bash
cd Claudex
npm install
npm run build
```

This produces 5 `.mjs` hook bundles in `dist/`:

| Hook                    | File                          | Trigger                        |
|-------------------------|-------------------------------|--------------------------------|
| SessionStart            | `dist/session-start.mjs`      | Session begins                 |
| PreCompact              | `dist/pre-compact.mjs`        | Before context compaction      |
| SessionEnd              | `dist/session-end.mjs`        | Session ends                   |
| UserPromptSubmit        | `dist/user-prompt-submit.mjs` | User submits a prompt          |
| PostToolUse             | `dist/post-tool-use.mjs`      | After a tool call completes    |

## Registering Hooks in Claude Code

Add the following to your Claude Code `settings.json` (typically `~/.claude/settings.json`).

### Unix / macOS

The `hooks/` directory contains `.sh` wrappers. Make them executable first:

```bash
chmod +x hooks/*.sh
```

Then register in `settings.json`:

```json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "/path/to/Claudex/hooks/session-start.sh" }]
      }
    ],
    "PreCompact": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "/path/to/Claudex/hooks/pre-compact.sh" }]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "/path/to/Claudex/hooks/session-end.sh" }]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "/path/to/Claudex/hooks/user-prompt-submit.sh" }]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "/path/to/Claudex/hooks/post-tool-use.sh" }]
      }
    ]
  }
}
```

Replace `/path/to/Claudex` with the actual path to the `Claudex/` directory.

### Windows

The `hooks/` directory contains `.cmd` wrappers. Register in `settings.json`:

```json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "C:\\path\\to\\Claudex\\hooks\\session-start.cmd" }]
      }
    ],
    "PreCompact": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "C:\\path\\to\\Claudex\\hooks\\pre-compact.cmd" }]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "C:\\path\\to\\Claudex\\hooks\\session-end.cmd" }]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "C:\\path\\to\\Claudex\\hooks\\user-prompt-submit.cmd" }]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [{ "type": "command", "command": "C:\\path\\to\\Claudex\\hooks\\post-tool-use.cmd" }]
      }
    ]
  }
}
```

Replace `C:\path\to\Claudex` with the actual path.

## Migration from PowerShell Hooks

If you were using the v1 PowerShell hooks:

1. **Keep your old hooks available.** The v1 PowerShell scripts remain in `Inheritance/Claudex/hooks/` and continue to work independently. You can switch back at any time by restoring the old `settings.json` entries.

2. **Update `settings.json`** to point to the new TypeScript hook wrappers (`.sh` or `.cmd` as shown above) instead of the old `.ps1` paths.

3. **No data migration needed.** The v2 SQLite database is created fresh on first run. Session history from v1 flat files is not imported automatically.

4. **To revert**, replace the hook paths in `settings.json` back to the v1 PowerShell scripts.

## Development

```bash
npm run typecheck    # Type check without emitting
npm run test         # Run tests
npm run test:watch   # Run tests in watch mode
npm run build        # Bundle hooks to dist/
```

## Project Structure

```
src/
  hooks/              # Hook entry points (one per Claude Code hook event)
    _infrastructure.ts  # Shared hook plumbing (not an entry point)
  db/                 # SQLite connection, schema, migrations, FTS5 search
  hologram/           # TCP client for Python hologram sidecar
  lib/                # Context assembler, observation extractor, flat-file mirror
  shared/             # Config, paths, types, scope detection, logging, errors
hooks/                # Shell wrappers (.sh for Unix, .cmd for Windows)
sidecar/              # Python hologram TCP server
dist/                 # Built .mjs bundles (generated by npm run build)
```
